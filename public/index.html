<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard ESP32 + MQ2</title>
  <!-- Biblioteca Chart.js usada para desenhar os gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <!-- Estilos locais -->
  <link rel="stylesheet" href="/styles.css">
  <!-- Fonte Inter do Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- Cabe√ßalho: t√≠tulo e indicador de status do MQTT -->
    <header>
      <h1>üìä Dashboard</h1>
      <div class="status-badge">
        <!-- `#mqtt-dot` e `#mqtt-text` s√£o atualizados via JS para mostrar conex√£o MQTT -->
        <span class="status-dot disconnected" id="mqtt-dot"></span>
        <span id="mqtt-text">Desconectado</span>
      </div>
    </header>

    <!-- Cart√µes com valores principais (ADC, PPM, Status) -->
    <div class="cards">
      <div class="card gas">
        <div class="card-title">Valor ADC</div>
        <div class="card-value" id="val-gas">0</div>
        <div class="card-unit">0 - 4095</div>
      </div>

      <div class="card ppm">
        <div class="card-title">Concentra√ß√£o (PPM)</div>
        <div class="card-value" id="val-ppm">0.00</div>
        <div class="card-unit">partes por milh√£o</div>
      </div>

      <div class="card status">
        <div class="card-title">Status</div>
        <div class="card-value" id="val-status">AGUARDANDO</div>
        <div class="card-unit" id="val-time">--:--:--</div>
      </div>
    </div>

    <!-- Bot√µes de controle do frontend -->
    <div class="controls">
      <button class="btn btn-primary" onclick="refresh()">üîÑ Atualizar</button>
      <button class="btn btn-success" onclick="exportCSV()">üì• Exportar CSV</button>
      <button class="btn btn-danger" onclick="clearHistory()">üóëÔ∏è Limpar Hist√≥rico</button>
    </div>

    <!-- √Årea dos gr√°ficos (PPM e ADC) -->
    <div class="charts-grid">
      <div class="chart-container">
        <h3>üìà PPM ao Longo do Tempo</h3>
        <canvas id="chart-ppm"></canvas>
      </div>
      <div class="chart-container">
        <h3>üìä Valor ADC ao Longo do Tempo</h3>
        <canvas id="chart-adc"></canvas>
      </div>
    </div>

    <!-- Tabela com hist√≥rico das √∫ltimas leituras -->
    <div class="table-container">
      <h3>üìã Hist√≥rico de Medi√ß√µes (√∫ltimas 30)</h3>
      <table>
        <thead>
          <tr><th>#</th><th>Hor√°rio</th><th>ADC</th><th>PPM</th><th>Status</th></tr>
        </thead>
        <tbody id="history-body">
          <tr><td colspan="5">Aguardando dados do ESP32...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Vari√°veis principais em escopo de script
    let ws = null;        // conex√£o WebSocket com o servidor
    let history = [];     // hist√≥rico local em mem√≥ria (clonado do servidor)
    let charts = {};      // refer√™ncias aos objetos Chart.js

    // Abre/gerencia a conex√£o WebSocket com o servidor (mesmo host da p√°gina)
    function connectWS(){
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}`);

      // Ao abrir a conex√£o, atualiza indicador visual
      ws.onopen = () => { console.log('WebSocket aberto'); updateMQTTStatus('connected'); };

      // Recebe mensagens do servidor e roteia por tipo
      ws.onmessage = e => {
        const msg = JSON.parse(e.data);
        if(msg.type === 'data') updateData(msg.data);                          // nova leitura
        else if(msg.type === 'init'){ history = msg.data.history || []; updateData(msg.data); } // estado inicial
        else if(msg.type === 'mqtt') updateMQTTStatus(msg.status);             // status de conex√£o MQTT
        else if(msg.type === 'cleared'){ history = []; updateTable(); updateCharts(); } // hist√≥rico limpo
      };

      // Erro/fechamento: tenta reconectar em 3s e atualiza indicador
      ws.onerror = () => updateMQTTStatus('disconnected');
      ws.onclose = () => { updateMQTTStatus('disconnected'); setTimeout(connectWS,3000); };
    }

    // Atualiza os elementos visuais com os dados mais recentes
    function updateData(data){
      document.getElementById('val-gas').textContent = data.gas;
      document.getElementById('val-ppm').textContent = (data.ppm||0).toFixed(2);
      document.getElementById('val-status').textContent = data.status;
      document.getElementById('val-time').textContent = new Date(data.timestamp).toLocaleTimeString('pt-BR');

      // Mant√©m hist√≥rico local (mesmo limite do servidor)
      history.push(data); if(history.length>200) history.shift();
      updateCharts(); updateTable();
    }

    // Atualiza o indicador visual de conex√£o MQTT
    function updateMQTTStatus(st){
      const dot = document.getElementById('mqtt-dot'); const t = document.getElementById('mqtt-text');
      if(st === 'connected'){ dot.className='status-dot connected'; t.textContent='MQTT Conectado'; }
      else { dot.className='status-dot disconnected'; t.textContent='MQTT Desconectado'; }
    }

    // Renderiza a tabela de hist√≥rico (√∫ltimos 30 registros)
    function updateTable(){
      const tbody = document.getElementById('history-body');
      if(history.length === 0){ tbody.innerHTML = '<tr><td colspan="5">Nenhum dado no hist√≥rico</td></tr>'; return; }
      tbody.innerHTML = history.slice(-30).reverse().map((item,idx)=>{
        const time = new Date(item.timestamp).toLocaleTimeString('pt-BR');
        return `<tr><td>#${history.length-idx}</td><td>${time}</td><td>${item.gas}</td><td>${(item.ppm||0).toFixed(2)}</td><td>${item.status}</td></tr>`;
      }).join('');
    }

    // Inicializa os gr√°ficos Chart.js (PPM e ADC)
    function initCharts(){
      const ppmCtx = document.getElementById('chart-ppm').getContext('2d');
      charts.ppm = new Chart(ppmCtx,{type:'line',data:{labels:[],datasets:[{label:'PPM',data:[],borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.1)',fill:true,tension:0.4}]},options:{plugins:{legend:{display:false}}}});
      const adcCtx = document.getElementById('chart-adc').getContext('2d');
      charts.adc = new Chart(adcCtx,{type:'line',data:{labels:[],datasets:[{label:'ADC',data:[],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',fill:true,tension:0.4}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:4095}}}});
    }

    // Atualiza dados dos gr√°ficos com os √∫ltimos pontos do hist√≥rico
    function updateCharts(){
      if(history.length===0) return;
      const last = history.slice(-20);
      const labels = last.map(h=>new Date(h.timestamp).toLocaleTimeString('pt-BR'));
      charts.ppm.data.labels = labels; charts.ppm.data.datasets[0].data = last.map(h=>h.ppm||0); charts.ppm.update('none');
      charts.adc.data.labels = labels; charts.adc.data.datasets[0].data = last.map(h=>h.gas||0); charts.adc.update('none');
    }

    // Fun√ß√µes utilit√°rias de interface: refresh, exportar CSV e limpar hist√≥rico
    function refresh(){ fetch('/api/current').then(r=>r.json()).then(d=>updateData(d)); }
    function exportCSV(){ if(history.length===0){ alert('Nenhum dado'); return; } let csv='Hor√°rio,ADC,PPM,Status\n'; history.forEach(h=>{ csv+=`${new Date(h.timestamp).toLocaleString('pt-BR')},${h.gas},${(h.ppm||0).toFixed(2)},${h.status}\n`; }); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`esp32-dados-${Date.now()}.csv`; a.click(); }
    function clearHistory(){ if(confirm('Tem certeza?')) fetch('/api/clear',{method:'POST'}).then(()=>{ history=[]; updateTable(); updateCharts(); }); }

    // Inicializa√ß√£o ao carregar a p√°gina: configura gr√°ficos e inicia WS
    document.addEventListener('DOMContentLoaded',()=>{ initCharts(); connectWS(); });
  </script>
</body>
</html>